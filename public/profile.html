<!-- profile.html -->
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Perfil do Usuário</title>
    <link rel="stylesheet" href="css/style-profile-mobile.css" />
    <link rel="stylesheet" href="css/style-profile.css" />
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="container-logo">
        <div class="foto"></div>
        <div class="texto">Fila Hospitalar</div>
      </div>
      <ul class="nav-links">
        <li><a href="hospitais.html">Hospitais</a></li>
        <li><a href="#" id="logout">Sair</a></li>
      </ul>
    </nav>

    <div class="container">
      <h2>Meu Perfil</h2>

      <div class="container-input">
        <form id="profileForm">
          <input type="text" id="nome" placeholder="Nome completo" required />
          <input type="password" id="senha" placeholder="Nova senha" />
          <button type="submit">Atualizar</button>
        </form>
      </div>

      <button id="deleteAccount" class="btn-delete">Deletar Conta</button>
    </div>

    <!-- Script para gerenciar o perfil -->
    <script>
      const token = localStorage.getItem("token");

      if (!token) {
        alert("Você precisa estar logado para acessar esta página.");
        window.location.href = "/login.html";
      } else {
        // Carregar dados do perfil
        fetch("/user/profile", {
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("nome").value = data.nome;
          })
          .catch((error) => {
            console.error("Erro ao carregar perfil:", error);
            alert("Erro ao carregar perfil.");
          });

        // Atualizar perfil
        document
          .getElementById("profileForm")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            const nome = document.getElementById("nome").value;
            const senha = document.getElementById("senha").value;

            fetch("/user/profile", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token,
              },
              body: JSON.stringify({ nome, senha }),
            })
              .then(async (response) => {
                const result = await response.json();
                if (response.ok) {
                  alert(result.message);
                  // Limpar o campo de senha
                  document.getElementById("senha").value = "";
                } else {
                  alert("Erro: " + result.message);
                }
              })
              .catch((error) => {
                console.error("Erro ao atualizar perfil:", error);
                alert("Erro ao atualizar perfil.");
              });
          });

        // Deletar conta
        document
          .getElementById("deleteAccount")
          .addEventListener("click", () => {
            if (
              confirm(
                "Tem certeza de que deseja deletar sua conta? Essa ação não pode ser desfeita."
              )
            ) {
              fetch("/user/profile", {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + token,
                },
              })
                .then(async (response) => {
                  const result = await response.json();
                  if (response.ok) {
                    alert(result.message);
                    localStorage.removeItem("token");
                    window.location.href = "/";
                  } else {
                    alert("Erro: " + result.message);
                  }
                })
                .catch((error) => {
                  console.error("Erro ao deletar conta:", error);
                  alert("Erro ao deletar conta.");
                });
            }
          });

        // Logout
        document.getElementById("logout").addEventListener("click", () => {
          localStorage.removeItem("token");
          window.location.href = "/login.html";
        });
      }
    </script>
  </body>
</html>
